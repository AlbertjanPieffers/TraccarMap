<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Live GPS Tracker (met richting)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    #map {
      height: 100vh;
      width: 100%;
    }
    .leaflet-marker-icon.rotated {
      transition: transform 0.5s ease;
    }
  </style>
</head>
<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const TRACCAR_WS = "wss://server.traccar.org/api/socket";
  const EMAIL = "reclameappie@gmail.com";
  const PASSWORD = "xy3s9e6k";
  const DEVICE_ID = 7919;

  // Init kaart
  const map = L.map("map", { zoomControl: false }).setView([52.3038209, 6.505169], 17);
  L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
    attribution: "",
    subdomains: "abcd"
  }).addTo(map);

  // Auto icoon
  const carIcon = L.icon({
    iconUrl: "https://i.postimg.cc/FKFw4jNt/Pngtree-vector-car-icon-4292542-removebg-preview.png",
    iconSize: [40, 40],
    iconAnchor: [20, 20],
    className: "rotated"
  });

  // Voeg marker toe
  let carMarker = L.marker([52.3038209, 6.505169], {
    icon: carIcon,
    rotationAngle: 0
  }).addTo(map);

  // Smooth move + rotate functie
  function smoothMoveAndRotate(marker, newLat, newLng, newCourse, duration = 1000) {
    const start = marker.getLatLng();
    const end = L.latLng(newLat, newLng);
    const startTime = performance.now();

    const iconEl = marker.getElement();
    if (iconEl) {
      iconEl.style.transform = `rotate(${newCourse}deg)`;
    }

    function animate(time) {
      const progress = Math.min((time - startTime) / duration, 1);
      const lat = start.lat + (end.lat - start.lat) * progress;
      const lng = start.lng + (end.lng - start.lng) * progress;
      marker.setLatLng([lat, lng]);
      map.setView([lat, lng]);

      if (progress < 1) {
        requestAnimationFrame(animate);
      }
    }

    requestAnimationFrame(animate);
  }

  // Maak verbinding met WebSocket
  function connectWebSocket() {
    const socket = new WebSocket(TRACCAR_WS);

    socket.onopen = () => {
      console.log("‚úÖ Verbonden met Traccar WebSocket");
      socket.send(JSON.stringify({
        action: "login",
        email: EMAIL,
        password: PASSWORD
      }));
    };

    socket.onmessage = (event) => {
      const data = JSON.parse(event.data);
      let position = null;

      if (data.positions && data.positions.length > 0) {
        position = data.positions.find(p => p.deviceId === DEVICE_ID);
      } else if (data.position && data.position.deviceId === DEVICE_ID) {
        position = data.position;
      }

      if (position) {
        smoothMoveAndRotate(carMarker, position.latitude, position.longitude, position.course || 0);
      }
    };

    socket.onerror = (err) => {
      console.error("‚ùå WebSocket fout:", err);
    };

    socket.onclose = () => {
      console.warn("üîÅ WebSocket gesloten, opnieuw verbinden in 5s...");
      setTimeout(connectWebSocket, 5000);
    };
  }

  connectWebSocket();
</script>

</body>
</html>
