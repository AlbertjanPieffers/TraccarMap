<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Live GPS Tracker - Kaart draait mee</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html, body {
      margin: 0;
      padding: 0;
    }

    #map-container {
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      position: relative;
    }

    #map {
      height: 100%;
      width: 100%;
      transform-origin: center center;
      transition: transform 0.5s ease;
    }

    .leaflet-marker-icon.car-icon {
      transform: rotate(0deg);
      transition: transform 0.5s ease;
    }
  </style>
</head>
<body>

<div id="map-container">
  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const DEVICE_ID = 441821; // âœ… Jouw juiste device ID
  const TOKEN = "RzBFAiEAziGHuGVQcGqQB2K6g3Uf_n1qUndOixKwwVj-3A3Guj4CIEFCGPpCa_V3zof0LzKkornhwL3j3VgeaFK0vtyGPrlKeyJ1IjoyMjExLCJlIjoiMjAzMi0wMS0yN1QyMzowMDowMC4wMDArMDA6MDAifQ"; // â¬…ï¸ Vul hier je API-token in
  const WS_URL = `wss://server.traccar.org/api/socket?token=${TOKEN}`;
  const REST_URL = "https://server.traccar.org/api/positions";

  let currentRotation = 0;

  // Init kaart
  const map = L.map("map", {
    zoomControl: false,
    attributionControl: false
  }).setView([52.3038209, 6.505169], 20);

  L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
    subdomains: "abcd"
  }).addTo(map);

  // Auto-icoon
  const carIcon = L.icon({
    iconUrl: "https://cdn-icons-png.flaticon.com/512/3429/3429725.png",
    iconSize: [40, 40],
    iconAnchor: [20, 20],
    className: "car-icon"
  });

  let carMarker = L.marker([0, 0], { icon: carIcon }).addTo(map);

  // ğŸ“ Smooth beweging & draaiing
  function smoothUpdate(lat, lon, course) {
    const newLatLng = L.latLng(lat, lon);
    carMarker.setLatLng(newLatLng);

    // Draai kaart met de course
    const mapElement = document.getElementById("map");
    const rotation = -course; // Kaart draait, dus tegengesteld
    mapElement.style.transform = `rotate(${rotation}deg)`;

    // Auto blijft omhoog gericht
    const markerEl = carMarker.getElement();
    if (markerEl) {
      markerEl.style.transform = `rotate(${course}deg)`;
    }

    // Center map (voor kaartrotatie moet de view meedraaien)
    map.setView(newLatLng);
  }

  // ğŸŒ Haal laatste positie op bij opstart
  async function fetchInitialPosition() {
    const res = await fetch(REST_URL, {
      headers: { Authorization: `Bearer ${TOKEN}` }
    });

    const data = await res.json();
    const pos = data.find(p => p.deviceId === DEVICE_ID);
    if (pos) {
      smoothUpdate(pos.latitude, pos.longitude, pos.course || 0);
    }
  }

  // ğŸ”Œ WebSocket voor live updates
  function connectWebSocket() {
    const socket = new WebSocket(WS_URL);

    socket.onopen = () => {
      console.log("âœ… Verbonden met Traccar WebSocket");
    };

    socket.onmessage = (event) => {
      const data = JSON.parse(event.data);
      let pos = null;

      if (data.positions && data.positions.length > 0) {
        pos = data.positions.find(p => p.deviceId === DEVICE_ID);
      } else if (data.position && data.position.deviceId === DEVICE_ID) {
        pos = data.position;
      }

      if (pos) {
        smoothUpdate(pos.latitude, pos.longitude, pos.course || 0);
      }
    };

    socket.onerror = err => {
      console.error("âŒ WebSocket fout:", err);
    };

    socket.onclose = () => {
      console.warn("ğŸ” WebSocket gesloten, opnieuw verbinden in 5s...");
      setTimeout(connectWebSocket, 5000);
    };
  }

  // ğŸš€ Start
  fetchInitialPosition();
  connectWebSocket();
</script>

</body>
</html>
